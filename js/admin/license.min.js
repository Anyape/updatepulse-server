jQuery(document).ready(function(e){function a(e){function a(){e.target.querySelectorAll(".upserv-license-error").forEach(e=>e.classList.remove("upserv-license-error"))}function n(e){e.classList.add("upserv-license-error")}e.preventDefault();const l={required:e=>""!==e.trim(),email:e=>/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(e.trim()),slug:e=>/^[a-z0-9-]+$/.test(e.trim()),licenseDate:e=>/[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])/.test(e.trim())||""===e.trim()};let t=!0;const i={licenseKey:{el:document.getElementById("upserv_license_key"),validate:"required"},licensePackageSlug:{el:document.getElementById("upserv_license_package_slug"),validate:"slug"},registeredEmail:{el:document.getElementById("upserv_license_registered_email"),validate:"email"},dateCreated:{el:document.getElementById("upserv_license_date_created"),validate:["required","licenseDate"]},dateExpiry:{el:document.getElementById("upserv_license_date_expiry"),validate:"licenseDate"},dateRenewed:{el:document.getElementById("upserv_license_date_renewed"),validate:"licenseDate"},maxAllowedDomains:{el:document.getElementById("upserv_license_max_allowed_domains"),validate:"required"}};a();for(const[e,a]of Object.entries(i)){const e=a.el.value,i=Array.isArray(a.validate)?a.validate:[a.validate];for(const s of i)if(!l[s](e)){t=!1,n(a.el);break}}if(t){const a={id:document.getElementById("upserv_license_id").innerHTML,license_key:i.licenseKey.el.value,max_allowed_domains:i.maxAllowedDomains.el.value,allowed_domains:Array.from(document.querySelectorAll(".upserv-domains-list li:not(.upserv-domain-template) .upserv-domain-value")).map(e=>e.textContent),status:document.getElementById("upserv_license_status").value,owner_name:document.getElementById("upserv_license_owner_name").value,email:i.registeredEmail.el.value,company_name:document.getElementById("upserv_license_owner_company").value,txn_id:document.getElementById("upserv_license_transaction_id").value,data:s.codemirror.getValue(),date_created:i.dateCreated.el.value,date_renewed:i.dateRenewed.el.value,date_expiry:i.dateExpiry.el.value,package_slug:i.licensePackageSlug.el.value,package_type:document.getElementById("upserv_license_package_type").value};document.getElementById("upserv_license_values").value=JSON.stringify(a),document.querySelectorAll(".no-submit").forEach(e=>e.removeAttribute("name")),e.target.submit()}}function n(a){if(r&&(s=s.initialize(e("#upserv_license_data"),UPServAdminLicense.cm_settings),r=!1),a&&a.constructor===Object){if(e("#upserv_license_id").html(a.id),e("#upserv_license_key").val(a.license_key),e("#upserv_license_date_created").val(a.date_created),e("#upserv_license_max_allowed_domains").val(a.max_allowed_domains),e("#upserv_license_owner_name").val(a.owner_name),e("#upserv_license_registered_email").val(a.email),e("#upserv_license_owner_company").val(a.company_name),e("#upserv_license_transaction_id").val(a.txn_id),e("#upserv_license_package_slug").val(a.package_slug),e("#upserv_license_status").val(a.status),e("#upserv_license_data").val("string"==typeof a.data?JSON.stringify(JSON.parse(a.data),null,"\t"):"{}"),e("#upserv_license_package_type").val(a.package_type),s.codemirror.setValue(e("#upserv_license_data").val()),"0000-00-00"!==a.date_expiry&&e("#upserv_license_date_expiry").val(a.date_expiry),"0000-00-00"!==a.date_renewed&&e("#upserv_license_date_renewed").val(a.date_renewed),a.allowed_domains.length>0){var n=e(".upserv-domains-list"),l=n.find("li").clone();l.removeClass("upserv-domain-template"),e.each(a.allowed_domains,function(e,a){var t=l.clone();t.find(".upserv-domain-value").html(a),n.append(t)}),e(".upserv-no-domain").hide(),n.show()}}else e("#upserv_license_key").val(e("#upserv_license_key").data("random_key")),e("#upserv_license_date_created").val((new Date).toISOString().slice(0,10)),e("#upserv_license_max_allowed_domains").val(1),s.codemirror.setValue("{}")}function l(){e("#upserv_license").trigger("reset"),e("upserv_license_values").val(""),e("upserv_license_action").val(""),e(".open-panel").removeAttr("disabled"),e(".upserv-licenses-table .open-panel").show(),e("#upserv_license_id").html(""),e(".upserv-domains-list li:not(.upserv-domain-template)").remove(),e(".upserv-no-domain").show(),e("label.upserv-license-error").hide(),e(".upserv-license-error").removeClass("upserv-license-error"),s.codemirror.setValue("{}")}function t(e,a){e.is(":visible")||e.slideDown(100,function(){a(e),e.find(".inside").animate({opacity:"1"},150)})}function i(e,a){e.is(":visible")&&e.slideUp(100,function(){e.find(".inside").css({opacity:"0"}),a(e)})}var s=wp.codeEditor,r=!0;e(".upserv-wrap .wp-list-table .delete a").on("click",function(a){window.confirm(UPServAdminLicense_l10n.deleteLicenseConfirm)||a.preventDefault(),e(this).attr("href",e(this).data("href"))}),e(".upserv-delete-all-licenses").on("click",function(e){window.confirm(UPServAdminLicense_l10n.deleteLicensesConfirm)||e.preventDefault()}),e("#upserv_modal_license_details").on("open",function(a,n){var l,t=e(this);n.closest("tr").find('input[name="license_data[]"]').val()&&(l=JSON.parse(n.closest("tr").find('input[name="license_data[]"]').val())),"object"!=typeof l&&(l={}),l.data&&(l.data=JSON.parse(l.data)),"object"!=typeof l.data&&(l.data={}),t.find("h2").html(l.license_key+"<br>"+l.package_slug+" - "+l.owner_name+" ("+l.email+")"),t.find("pre").text(JSON.stringify(l,null,2))}),e("#add_license_trigger").on("click",function(){t(e("#upserv_license_panel"),function(){n(),e("#upserv_license_action").val("create"),e(".upserv-edit-license-label").hide(),e(".upserv-license-show-if-edit").hide(),e(".upserv-add-license-label").show(),e(".open-panel").attr("disabled","disabled"),e(".upserv-licenses-table .open-panel").hide(),e("html, body").animate({scrollTop:e("#upserv_license_panel").offset().top-e("#wpadminbar").height()-20},500)})}),e(".upserv-licenses-table .open-panel .edit a").on("click",function(a){var l;a.preventDefault(),l=e(this).closest("tr").find('input[name="license_data[]"]').val()?JSON.parse(e(this).closest("tr").find('input[name="license_data[]"]').val()):{},"object"!=typeof l&&(l={}),t(e("#upserv_license_panel"),function(){n(l),e("#upserv_license_action").val("update"),e(".upserv-edit-license-label").show(),e(".upserv-license-show-if-edit").show(),e(".upserv-add-license-label").hide(),e(".open-panel").attr("disabled","disabled"),e(".upserv-licenses-table .open-panel").hide(),e("html, body").animate({scrollTop:e("#upserv_license_panel").offset().top-e("#wpadminbar").height()-20},500)})}),e("#upserv_license_cancel, .close-panel.reset").on("click",function(){e("html, body").animate({scrollTop:e(".upserv-wrap").offset().top-e("#wpadminbar").height()-20},150),i(e("#upserv_license_panel"),function(){l()})}),document.getElementById("upserv_license").addEventListener("submit",a),e("#upserv_license_registered_domains").on("click",".upserv-remove-domain",function(a){a.preventDefault(),e(this).parent().remove(),1>=e(".upserv-remove-domain").length&&e(".upserv-no-domain").show()})});