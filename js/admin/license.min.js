jQuery(document).ready(function(e){function s(s){if(r&&(l=l.initialize(e("#upserv_license_data"),UPServAdminLicense.cm_settings),r=!1),s&&s.constructor===Object){if(e("#upserv_license_id").html(s.id),e("#upserv_license_key").val(s.license_key),e("#upserv_license_date_created").val(s.date_created),e("#upserv_license_max_allowed_domains").val(s.max_allowed_domains),e("#upserv_license_owner_name").val(s.owner_name),e("#upserv_license_registered_email").val(s.email),e("#upserv_license_owner_company").val(s.company_name),e("#upserv_license_transaction_id").val(s.txn_id),e("#upserv_license_package_slug").val(s.package_slug),e("#upserv_license_status").val(s.status),e("#upserv_license_data").val("string"==typeof s.data?JSON.stringify(JSON.parse(s.data),null,"\t"):"{}"),e("#upserv_license_package_type").val(s.package_type),l.codemirror.setValue(e("#upserv_license_data").val()),"0000-00-00"!==s.date_expiry&&e("#upserv_license_date_expiry").val(s.date_expiry),"0000-00-00"!==s.date_renewed&&e("#upserv_license_date_renewed").val(s.date_renewed),s.allowed_domains.length>0){var a=e(".upserv-domains-list"),n=a.find("li").clone();n.removeClass("upserv-domain-template"),e.each(s.allowed_domains,function(e,s){var i=n.clone();i.find(".upserv-domain-value").html(s),a.append(i)}),e(".upserv-no-domain").hide(),a.show()}}else e("#upserv_license_key").val(e("#upserv_license_key").data("random_key")),e("#upserv_license_date_created").val((new Date).toISOString().slice(0,10)),e("#upserv_license_max_allowed_domains").val(1),l.codemirror.setValue("{}")}function a(){e("#upserv_license").trigger("reset"),e("upserv_license_values").val(""),e("upserv_license_action").val(""),e(".open-panel").removeAttr("disabled"),e(".upserv-licenses-table .open-panel").show(),e("#upserv_license_id").html(""),e(".upserv-domains-list li:not(.upserv-domain-template)").remove(),e(".upserv-no-domain").show(),e("label.upserv-license-error").hide(),e(".upserv-license-error").removeClass("upserv-license-error"),l.codemirror.setValue("{}")}function n(e,s){e.is(":visible")||e.slideDown(100,function(){s(e),e.find(".inside").animate({opacity:"1"},150)})}function i(e,s){e.is(":visible")&&e.slideUp(100,function(){e.find(".inside").css({opacity:"0"}),s(e)})}var l=wp.codeEditor,r=!0;e(".upserv-delete-all-licenses").on("click",function(e){var s=window.confirm(UPServAdminLicense_l10n.deleteLicensesConfirm);s||e.preventDefault()}),e("#upserv_modal_license_details").on("open",function(s,a){var n,i=e(this);n=a.closest("tr").find('input[name="license_data[]"]').val()?JSON.parse(a.closest("tr").find('input[name="license_data[]"]').val()):{},"object"!=typeof n&&(n={}),n.data?n.data=JSON.parse(n.data):n.data={},i.find("h2").html(n.license_key+"<br>"+n.package_slug+" - "+n.owner_name+" ("+n.email+")"),i.find("pre").text(JSON.stringify(n,null,2))}),e("#add_license_trigger").on("click",function(){n(e("#upserv_license_panel"),function(){s(),e("#upserv_license_action").val("create"),e(".upserv-edit-license-label").hide(),e(".upserv-license-show-if-edit").hide(),e(".upserv-add-license-label").show(),e(".open-panel").attr("disabled","disabled"),e(".upserv-licenses-table .open-panel").hide(),e("html, body").animate({scrollTop:e("#upserv_license_panel").offset().top-e("#wpadminbar").height()-20},500)})}),e(".upserv-licenses-table .open-panel .edit a").on("click",function(a){var i;a.preventDefault(),i=e(this).closest("tr").find('input[name="license_data[]"]').val()?JSON.parse(e(this).closest("tr").find('input[name="license_data[]"]').val()):{},"object"!=typeof i&&(i={}),n(e("#upserv_license_panel"),function(){s(i),e("#upserv_license_action").val("update"),e(".upserv-edit-license-label").show(),e(".upserv-license-show-if-edit").show(),e(".upserv-add-license-label").hide(),e(".open-panel").attr("disabled","disabled"),e(".upserv-licenses-table .open-panel").hide(),e("html, body").animate({scrollTop:e("#upserv_license_panel").offset().top-e("#wpadminbar").height()-20},500)})}),e("#upserv_license_cancel, .close-panel.reset").on("click",function(){e("html, body").animate({scrollTop:e(".upserv-wrap").offset().top-e("#wpadminbar").height()-20},150),i(e("#upserv_license_panel"),function(){a()})}),e.validator&&(e.validator.methods.licenseDate=function(e,s){return this.optional(s)||/[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[1-2][0-9]|3[0-1])/.test(e)},e.validator.methods.slug=function(e,s){return this.optional(s)||/[a-z0-9-]*/.test(e)},e("#upserv_license").validate({ignore:".CodeMirror *",errorClass:"upserv-license-error",rules:{upserv_license_key:{required:!0},upserv_license_package_slug:{required:!0,slug:!0},upserv_license_registered_email:{required:!0,email:!0},upserv_license_date_created:{required:!0,licenseDate:!0},upserv_license_date_expiry:{licenseDate:!0},upserv_license_date_renewed:{licenseDate:!0},upserv_license_max_allowed_domains:{required:!0}},submitHandler:function(s){var a=e(".upserv-domains-list li:not(.upserv-domain-template) .upserv-domain-value"),n={id:e("#upserv_license_id").html(),license_key:e("#upserv_license_key").val(),max_allowed_domains:e("#upserv_license_max_allowed_domains").val(),allowed_domains:a.map(function(){return e(this).text()}).get(),status:e("#upserv_license_status").val(),owner_name:e("#upserv_license_owner_name").val(),email:e("#upserv_license_registered_email").val(),company_name:e("#upserv_license_owner_company").val(),txn_id:e("#upserv_license_transaction_id").val(),data:l.codemirror.getValue(),date_created:e("#upserv_license_date_created").val(),date_renewed:e("#upserv_license_date_renewed").val(),date_expiry:e("#upserv_license_date_expiry").val(),package_slug:e("#upserv_license_package_slug").val(),package_type:e("#upserv_license_package_type").val()};e("#upserv_license_values").val(JSON.stringify(n)),e(".no-submit").removeAttr("name"),s.submit()}})),e("#upserv_license_registered_domains").on("click",".upserv-remove-domain",function(s){s.preventDefault(),e(this).parent().remove(),1>=e(".upserv-remove-domain").length&&e(".upserv-no-domain").show()})});