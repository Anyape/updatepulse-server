jQuery(document).ready(function(e){function n(e){var n=new Uint8Array(e),t="";window.crypto.getRandomValues(n);for(var i=0;i<n.length;i++)t+=n[i].toString(e).padStart(2,"0");return t}e("#upserv_modal_api_details").on("open",function(n,t){var i,c=e(this);t.closest("table").find(".api-data").val()?i=JSON.parse(t.closest("table").find(".api-data").val()):t.closest("h3").next("table").find(".api-data").val()&&(i=JSON.parse(t.closest("h3").next("table").find(".api-data").val())),"object"!=typeof i&&(i={}),c.find("h2").text(t.data("title")),c.find("pre").text(JSON.stringify(i,null,2))}),e(".webhook-multiple").each(function(t,i){function c(){var e=p.get(0).value.trim(),n=""!==e&&!Object.values(o).some(function(n){return n===e}),t=/^(https?:\/\/)?([\w-]+(\.[\w-]+)+\/?)|localhost(:\d+)?(\/[\w-]+)*\/?(\?\S*)?$/,c=/^UPDATEPULSE_L_[a-zA-Z0-9_-]+$/;n=n&&t.test(e)&&16<=d.val().length&&0!==i.find('.event-container input[type="checkbox"]:checked').length&&(0===l.val().length||c.test(l.val())),u.disabled=!n}function a(){v.innerHTML="",Object.keys(o).forEach(function(e){var n=document.createElement("div"),t=document.createElement("span"),i=document.createElement("span"),c=document.createElement("span"),p=document.createElement("button"),l="",d=o[e].events;if(2===d.length&&d.includes("package")&&d.includes("license"))l=UPServAdminApi_l10n.eventApiCountAll;else{var r={package:"",license:""};["package","license"].forEach(function(e,n){var t="package"===e?UPServAdminApi_l10n.eventApiTypePackage:UPServAdminApi_l10n.eventApiTypeLicense;d.includes(e)?r[e]=UPServAdminApi_l10n.eventApiCountAllType.replace("%s",t):1===d.filter(function(n){return n.startsWith(e)}).length?r[e]=UPServAdminApi_l10n.eventApiCountTypeSingular.replace("%s",t):d.filter(function(n){return n.startsWith(e)}).length&&(r[e]=UPServAdminApi_l10n.eventApiCountTypePlural.replace("%1$d",d.filter(function(n){return n.startsWith(e)}).length).replace("%2$s",t))}),l=""!==r.package&&""!==r.license?r.package+UPServAdminApi_l10n.apiSumSep+"<br>"+r.license:""!==r.package?r.package:r.license}n.className="item",t.textContent=o[e].url,t.title=o[e].url,t.classList="url",i.textContent=o[e].secret,i.classList="secret",c.innerHTML=l,c.title="("+o[e].events.join(", ")+")",c.classList="summary",p.type="button",p.innerHTML='<span class="upserv-remove-icon" aria-hidden="true"></span>',p.onclick=function(){confirm(UPServAdminApi_l10n.deleteApiWebhookConfirm)&&(delete o[e],a())},o[e].licenseAPIKey&&(t.title+="\n("+o[e].licenseAPIKey+")"),n.appendChild(c),n.appendChild(t),n.appendChild(i),n.appendChild(p),v.appendChild(n)}),0===Object.keys(o).length?v.classList.add("empty"):v.classList.remove("empty"),i.find(".webhook-values").val(JSON.stringify(o))}var o;i=e(i),i.find(".webhook-values").val()&&(o=JSON.parse(i.find(".webhook-values").val())),"object"!=typeof o&&(o={});var p=i.find(".new-webhook-item-url"),l=i.find(".new-webhook-item-license_api_key"),d=i.find(".new-webhook-item-secret"),r=i.find('input[data-webhook-event="all"]'),s=i.find('input[data-webhook-event="package"]'),h=i.find('input[data-webhook-event="license"]'),u=i.find(".webhook-add").get(0),v=i.find(".webhook-items").get(0);u.onclick=function(){if(u.disabled="disabled",i.find('.event-container.license input[type="checkbox"]:checked').length&&!l.val().length&&!confirm(UPServAdminApi_l10n.addWebhookNoLicenseApiConfirm))return u.disabled=!1,void a();var t=btoa(p.val().trim()).replace(/\//g,"|");o[t]={url:p.val(),secret:d.val(),licenseAPIKey:"UPDATEPULSE_L_"+l.val().replace(/^UPDATEPULSE_L_/,""),events:[]},s.prop("checked")&&s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1),h.prop("checked")&&h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1),s.closest(".event-container").find('.child input[type="checkbox"]').length===s.closest(".event-container").find('.child input[type="checkbox"]:checked').length&&(s.prop("checked",!0),s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1)),h.closest(".event-container").find('.child input[type="checkbox"]').length===h.closest(".event-container").find('.child input[type="checkbox"]:checked').length&&(h.prop("checked",!0),h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1)),i.find('.event-types input[type="checkbox"]').each(function(n,i){i=e(i),"all"!==i.data("webhook-event")&&i.prop("checked")&&o[t].events.push(i.data("webhook-event"))}),p.val(""),d.val(n(8)),l.val(""),r.prop("checked",!0),r.trigger("change"),a()},p.on("input",c),d.on("input",c),l.on("input",c),i.find('.event-types input[type="checkbox"]').on("change",function(){r.prop("checked")?(i.find('.event-types input[type="checkbox"]').prop("checked",!0),i.find('.event-types input[type="checkbox"]').prop("disabled",!0),r.prop("disabled",!1)):(i.find('.event-types input[type="checkbox"]').prop("disabled",!1),s.prop("checked")&&(s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!0),s.closest(".event-container").find('.child input[type="checkbox"]').prop("disabled",!0)),h.prop("checked")&&(h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!0),h.closest(".event-container").find('.child input[type="checkbox"]').prop("disabled",!0))),i.find('.event-container.license input[type="checkbox"]:checked').length?i.find(".show-if-license").removeClass("hidden"):i.find(".show-if-license").addClass("hidden"),c()}),r.prop("checked",!0),r.trigger("change"),a(),e('input[type="submit"]').on("click",function(n){n.preventDefault(),i.find(".webhook-values").val(JSON.stringify(o)),e(this).closest("form").submit()})}),e(".api-keys-multiple").each(function(t,i){function c(){var e=p.get(0).value.trim(),n=""!==e&&!Object.values(o).some(function(n){return n===e});n=n&&/^[a-zA-Z0-9_-]+$/.test(e)&&0!==i.find('.event-container:not(.other) input[type="checkbox"]:checked').length,d.disabled=!n}function a(){r.innerHTML="",Object.keys(o).forEach(function(e){var n=document.createElement("div"),t=document.createElement("span"),i=document.createElement("span"),c=document.createElement("span"),p=document.createElement("button"),l="",d=o[e].access;l=1===d.length&&"all"===d[0]?UPServAdminApi_l10n.actionApiCountAll:2===d.length&&d.includes("all")&&d.includes("other")?UPServAdminApi_l10n.actionApiCountAllOther:2===d.length&&d.includes("other")?UPServAdminApi_l10n.actionApiCountSingularOther:d.includes("other")?UPServAdminApi_l10n.actionApiCountPluralOther.replace("%d",d.length-1):1===d.length?UPServAdminApi_l10n.actionApiCountSingular:UPServAdminApi_l10n.actionApiCountPlural.replace("%d",d.length),n.className="item",t.textContent=e,t.classList="id",i.textContent=o[e].key,i.classList="key",c.textContent=l,c.title="("+o[e].access.join(", ")+")",c.classList="summary",p.type="button",p.innerHTML='<span class="upserv-remove-icon" aria-hidden="true"></span>',p.onclick=function(){confirm(UPServAdminApi_l10n.deleteApiKeyConfirm)&&(delete o[e],a())},n.appendChild(c),n.appendChild(t),n.appendChild(i),n.appendChild(p),r.appendChild(n)}),0===Object.keys(o).length?r.classList.add("empty"):r.classList.remove("empty"),i.find(".api-key-values").val(JSON.stringify(o))}var o;i=e(i),i.find(".api-key-values").val()&&(o=JSON.parse(i.find(".api-key-values").val())),"object"!=typeof o&&(o={});var p=i.find(".new-api-key-item-id"),l=i.find('input[data-api-action="all"]'),d=i.find(".api-keys-add").get(0),r=i.find(".api-keys-items").get(0),s=i.data("prefix");d.onclick=function(){var t=s+p.val().replace(new RegExp("^"+s),"");d.disabled="disabled",o[t]={key:n(16),access:[]},(l.prop("checked")||i.find('.event-container:not(.all, .other) input[type="checkbox"]').length===i.find('.event-container:not(.all, .other) input[type="checkbox"]:checked').length)&&(l.prop("checked",!0),i.find('.event-container:not(.all, .other) input[type="checkbox"]').prop("checked",!1),o[t].access.push("all")),i.find('.event-container input[type="checkbox"]').each(function(n,i){i=e(i),"all"!==i.data("api-action")&&i.prop("checked")&&(console.log(n),console.log(o),o[t].access.push(i.data("api-action")))}),i.find('.event-container.other input[type="checkbox"]').prop("checked",!1),l.prop("checked",!0),l.trigger("change"),p.val(""),c(),a()},p.on("input",c),i.find('.event-types input[type="checkbox"]').on("change",function(){l.prop("checked")?(i.find('.event-container:not(.other) input[type="checkbox"]').prop("checked",!0),i.find('.event-container:not(.other) input[type="checkbox"]').prop("disabled",!0),l.prop("disabled",!1)):i.find('.event-types input[type="checkbox"]').prop("disabled",!1),c()}),l.prop("checked",!0),l.trigger("change"),a(),e('input[type="submit"]').on("click",function(n){n.preventDefault(),i.find(".api-key-values").val(JSON.stringify(o)),e(this).closest("form").submit()})})});