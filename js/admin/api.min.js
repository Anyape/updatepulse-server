jQuery(document).ready(function(e){function n(e){var n=new Uint8Array(e),t="";window.crypto.getRandomValues(n);for(var i=0;i<n.length;i++)t+=n[i].toString(e).padStart(2,"0");return t}e("#upserv_modal_api_details").on("open",function(n,t){var i=JSON.parse(e(t.data("selector")).val()),c=e(this);c.find("h2").text(t.data("title")),c.find("pre").text(JSON.stringify(i,null,2))}),e(".webhook-multiple").each(function(t,i){function c(){var e=a.get(0).value.trim(),n=""!==e&&!Object.values(p).some(function(n){return n===e}),t=/^(https?:\/\/)?([\w-]+(\.[\w-]+)+\/?)|localhost(:\d+)?(\/[\w-]+)*\/?(\?\S*)?$/,c=/^UPDATEPULSE_L_[a-zA-Z0-9_-]+$/;n=n&&t.test(e)&&16<=d.val().length&&0!==i.find('.event-container input[type="checkbox"]:checked').length&&(0===l.val().length||c.test(l.val())),u.disabled=!n}function o(){v.innerHTML="",Object.keys(p).forEach(function(e){var n=document.createElement("div"),t=document.createElement("span"),i=document.createElement("span"),c=document.createElement("span"),a=document.createElement("button"),l="",d=p[e].events;if(2===d.length&&d.includes("package")&&d.includes("license"))l=UPServAdminApi_l10n.eventApiCountAll;else{var r={package:"",license:""};["package","license"].forEach(function(e,n){var t="package"===e?UPServAdminApi_l10n.eventApiTypePackage:UPServAdminApi_l10n.eventApiTypeLicense;d.includes(e)?r[e]=UPServAdminApi_l10n.eventApiCountAllType.replace("%s",t):1===d.filter(function(n){return n.startsWith(e)}).length?r[e]=UPServAdminApi_l10n.eventApiCountTypeSingular.replace("%s",t):d.filter(function(n){return n.startsWith(e)}).length&&(r[e]=UPServAdminApi_l10n.eventApiCountTypePlural.replace("%1$d",d.filter(function(n){return n.startsWith(e)}).length).replace("%2$s",t))}),l=""!==r.package&&""!==r.license?r.package+UPServAdminApi_l10n.apiSumSep+"<br>"+r.license:""!==r.package?r.package:r.license}n.className="item",t.textContent=p[e].url,t.title=p[e].url,t.classList="url",i.textContent=p[e].secret,i.classList="secret",c.innerHTML=l,c.title="("+p[e].events.join(", ")+")",c.classList="summary",a.type="button",a.innerHTML='<span class="upserv-remove-icon" aria-hidden="true"></span>',a.onclick=function(){confirm(UPServAdminApi_l10n.deleteApiWebhookConfirm)&&(delete p[e],o())},p[e].licenseAPIKey&&(t.title+="\n("+p[e].licenseAPIKey+")"),n.appendChild(c),n.appendChild(t),n.appendChild(i),n.appendChild(a),v.appendChild(n)}),0===Object.keys(p).length?v.classList.add("empty"):v.classList.remove("empty"),i.find(".webhook-values").val(JSON.stringify(p))}i=e(i);var p=JSON.parse(i.find(".webhook-values").val()),a=i.find(".new-webhook-item-url"),l=i.find(".new-webhook-item-license_api_key"),d=i.find(".new-webhook-item-secret"),r=i.find('input[data-webhook-event="all"]'),s=i.find('input[data-webhook-event="package"]'),h=i.find('input[data-webhook-event="license"]'),u=i.find(".webhook-add").get(0),v=i.find(".webhook-items").get(0);0===p.length&&(p={}),u.onclick=function(){if(u.disabled="disabled",i.find('.event-container.license input[type="checkbox"]:checked').length&&!l.val().length&&!confirm(UPServAdminApi_l10n.addWebhookNoLicenseApiConfirm))return u.disabled=!1,void o();var t=btoa(a.val().trim()).replace(/\//g,"|");p[t]={url:a.val(),secret:d.val(),licenseAPIKey:"UPDATEPULSE_L_"+l.val().replace(/^UPDATEPULSE_L_/,""),events:[]},s.prop("checked")&&s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1),h.prop("checked")&&h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1),s.closest(".event-container").find('.child input[type="checkbox"]').length===s.closest(".event-container").find('.child input[type="checkbox"]:checked').length&&(s.prop("checked",!0),s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1)),h.closest(".event-container").find('.child input[type="checkbox"]').length===h.closest(".event-container").find('.child input[type="checkbox"]:checked').length&&(h.prop("checked",!0),h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!1)),i.find('.event-types input[type="checkbox"]').each(function(n,i){i=e(i),"all"!==i.data("webhook-event")&&i.prop("checked")&&p[t].events.push(i.data("webhook-event"))}),a.val(""),d.val(n(8)),l.val(""),r.prop("checked",!0),r.trigger("change"),o()},a.on("input",c),d.on("input",c),l.on("input",c),i.find('.event-types input[type="checkbox"]').on("change",function(){r.prop("checked")?(i.find('.event-types input[type="checkbox"]').prop("checked",!0),i.find('.event-types input[type="checkbox"]').prop("disabled",!0),r.prop("disabled",!1)):(i.find('.event-types input[type="checkbox"]').prop("disabled",!1),s.prop("checked")&&(s.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!0),s.closest(".event-container").find('.child input[type="checkbox"]').prop("disabled",!0)),h.prop("checked")&&(h.closest(".event-container").find('.child input[type="checkbox"]').prop("checked",!0),h.closest(".event-container").find('.child input[type="checkbox"]').prop("disabled",!0))),i.find('.event-container.license input[type="checkbox"]:checked').length?i.find(".show-if-license").removeClass("hidden"):i.find(".show-if-license").addClass("hidden"),c()}),r.prop("checked",!0),r.trigger("change"),o(),e('input[type="submit"]').on("click",function(n){n.preventDefault(),i.find(".webhook-values").val(JSON.stringify(p)),e(this).closest("form").submit()})}),e(".api-keys-multiple").each(function(t,i){function c(){var e=a.get(0).value.trim(),n=""!==e&&!Object.values(p).some(function(n){return n===e});n=n&&/^[a-zA-Z0-9_-]+$/.test(e)&&0!==i.find('.event-container:not(.other) input[type="checkbox"]:checked').length,d.disabled=!n}function o(){r.innerHTML="",Object.keys(p).forEach(function(e){var n=document.createElement("div"),t=document.createElement("span"),i=document.createElement("span"),c=document.createElement("span"),a=document.createElement("button"),l="",d=p[e].access;l=1===d.length&&"all"===d[0]?UPServAdminApi_l10n.actionApiCountAll:2===d.length&&d.includes("all")&&d.includes("other")?UPServAdminApi_l10n.actionApiCountAllOther:2===d.length&&d.includes("other")?UPServAdminApi_l10n.actionApiCountSingularOther:d.includes("other")?UPServAdminApi_l10n.actionApiCountPluralOther.replace("%d",d.length-1):1===d.length?UPServAdminApi_l10n.actionApiCountSingular:UPServAdminApi_l10n.actionApiCountPlural.replace("%d",d.length),n.className="item",t.textContent=e,t.classList="id",i.textContent=p[e].key,i.classList="key",c.textContent=l,c.title="("+p[e].access.join(", ")+")",c.classList="summary",a.type="button",a.innerHTML='<span class="upserv-remove-icon" aria-hidden="true"></span>',a.onclick=function(){confirm(UPServAdminApi_l10n.deleteApiKeyConfirm)&&(delete p[e],o())},n.appendChild(c),n.appendChild(t),n.appendChild(i),n.appendChild(a),r.appendChild(n)}),0===Object.keys(p).length?r.classList.add("empty"):r.classList.remove("empty"),i.find(".api-key-values").val(JSON.stringify(p))}i=e(i);var p=JSON.parse(i.find(".api-key-values").val()),a=i.find(".new-api-key-item-id"),l=i.find('input[data-api-action="all"]'),d=i.find(".api-keys-add").get(0),r=i.find(".api-keys-items").get(0),s=i.data("prefix");0===p.length&&(p={}),d.onclick=function(){var t=s+a.val().replace(new RegExp("^"+s),"");d.disabled="disabled",p[t]={key:n(16),access:[]},(l.prop("checked")||i.find('.event-container:not(.all, .other) input[type="checkbox"]').length===i.find('.event-container:not(.all, .other) input[type="checkbox"]:checked').length)&&(l.prop("checked",!0),i.find('.event-container:not(.all, .other) input[type="checkbox"]').prop("checked",!1),p[t].access.push("all")),i.find('.event-container input[type="checkbox"]').each(function(n,i){i=e(i),"all"!==i.data("api-action")&&i.prop("checked")&&(console.log(n),console.log(p),p[t].access.push(i.data("api-action")))}),i.find('.event-container.other input[type="checkbox"]').prop("checked",!1),l.prop("checked",!0),l.trigger("change"),a.val(""),c(),o()},a.on("input",c),i.find('.event-types input[type="checkbox"]').on("change",function(){l.prop("checked")?(i.find('.event-container:not(.other) input[type="checkbox"]').prop("checked",!0),i.find('.event-container:not(.other) input[type="checkbox"]').prop("disabled",!0),l.prop("disabled",!1)):i.find('.event-types input[type="checkbox"]').prop("disabled",!1),c()}),l.prop("checked",!0),l.trigger("change"),o(),e('input[type="submit"]').on("click",function(n){n.preventDefault(),i.find(".api-key-values").val(JSON.stringify(p)),e(this).closest("form").submit()})})});